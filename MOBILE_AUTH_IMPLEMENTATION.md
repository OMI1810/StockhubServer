# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- `@nestjs/jwt` - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏
- `@nestjs/passport` –∏ `passport-jwt` - –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `@types/passport-jwt` - —Ç–∏–ø—ã –¥–ª—è TypeScript

### 2. –°–æ–∑–¥–∞–Ω JWT –º–æ–¥—É–ª—å –∏ —Å–µ—Ä–≤–∏—Å
- **`src/auth/jwt/jwt.module.ts`** - –º–æ–¥—É–ª—å JWT —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- **`src/auth/jwt/jwt.service.ts`** - —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–∫–µ–Ω–∞–º–∏:
  - `generateTokenPair()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Access Token + Refresh Token
  - `verifyAccessToken()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ Access Token
  - `validateRefreshTokenForRefresh()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è Refresh Token
  - `generateAccessToken()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ Access Token
  - `revokeRefreshToken()` - –æ—Ç–∑—ã–≤ Refresh Token

### 3. –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –≤ AuthService
- **`mobileLogin()`** - –ª–æ–≥–∏–Ω —Å –≤—ã–¥–∞—á–µ–π JWT —Ç–æ–∫–µ–Ω–æ–≤
- **`refreshToken()`** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Access Token —á–µ—Ä–µ–∑ Refresh Token
- **`mobileLogout()`** - –≤—ã—Ö–æ–¥ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º Refresh Token
- **`mobileRegister()`** - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### 4. –°–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- `POST /auth/mobile/login` - –ª–æ–≥–∏–Ω —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤
- `POST /auth/mobile/refresh` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Access Token
- `POST /auth/mobile/logout` - –≤—ã—Ö–æ–¥
- `POST /auth/mobile/register` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

### 5. –û–±–Ω–æ–≤–ª–µ–Ω AuthGuard (–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1**: –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞ (–∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <token>`)
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2**: –ü—Ä–æ–≤–µ—Ä–∫–∞ cookie-—Å–µ—Å—Å–∏–∏ (–¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞)
- –û–±–∞ –º–µ—Ç–æ–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

### 6. –û–±–Ω–æ–≤–ª–µ–Ω OrganizationRoleGuard
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è `organizationId` –∏–∑ JWT payload
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: URL ‚Üí JWT payload ‚Üí Session ‚Üí Body

### 7. –°–æ–∑–¥–∞–Ω DTO
- **`src/auth/dto/refresh-token.dto.ts`** - –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:

```env
JWT_SECRET=your-super-secret-jwt-key-minimum-32-characters-long
```

–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–∞:
```bash
openssl rand -base64 32
```

---

## üì± API –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –õ–æ–≥–∏–Ω
```http
POST /auth/mobile/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}

–û—Ç–≤–µ—Ç:
{
  "user": { ... },
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "550e8400-e29b-41d4-a716-446655440000",
  "expiresIn": 900
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
```http
POST /auth/mobile/refresh
Content-Type: application/json

{
  "refreshToken": "550e8400-e29b-41d4-a716-446655440000"
}

–û—Ç–≤–µ—Ç:
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 900
}
```

### –í—ã—Ö–æ–¥
```http
POST /auth/mobile/logout
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "refreshToken": "550e8400-e29b-41d4-a716-446655440000"
}
```

### –ó–∞–ø—Ä–æ—Å—ã –∫ API
```http
GET /organizations
Authorization: Bearer <access_token>
```

---

## üîê –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤

### Access Token (JWT)
- **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏**: 15 –º–∏–Ω—É—Ç
- **–°–æ–¥–µ—Ä–∂–∏—Ç**: `userId`, `email`, `role`, `currentOrganizationId` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: –í EncryptedSharedPreferences –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –í –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization: Bearer <token>`

### Refresh Token
- **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏**: 30 –¥–Ω–µ–π
- **–§–æ—Ä–º–∞—Ç**: UUID
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: –í Redis –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ Access Token

---

## ‚úÖ –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–æ–±–∞ –º–µ—Ç–æ–¥–∞** –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

1. **Cookie-—Å–µ—Å—Å–∏–∏** - –¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
2. **JWT —Ç–æ–∫–µ–Ω—ã** - –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–æ–≤–æ–µ)

–û–±–∞ –º–µ—Ç–æ–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏ –Ω–µ –º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É.

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–í—Å–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é. –î–æ–±–∞–≤—å—Ç–µ `JWT_SECRET` –≤ `.env` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

