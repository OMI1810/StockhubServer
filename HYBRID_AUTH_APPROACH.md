# –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: Cookie-—Å–µ—Å—Å–∏–∏ + JWT

## üìã –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥** –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥–≤–∞ –º–µ—Ç–æ–¥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
1. **Cookie-based —Å–µ—Å—Å–∏–∏** - –¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
2. **JWT + Refresh Token** - –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–û–±–∞ –º–µ—Ç–æ–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–µ –º–µ—à–∞—è –¥—Ä—É–≥ –¥—Ä—É–≥—É.

---

## üéØ –ö–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –í–µ–±-—Å–∞–π—Ç (–∫–∞–∫ —Å–µ–π—á–∞—Å)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí POST /auth/login
   ‚Üì
2. –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é –≤ Redis
   ‚Üì
3. –°–µ—Ä–≤–µ—Ä —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie —Å Session ID
   ‚Üì
4. –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
   ‚Üì
5. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é –∏–∑ Redis
   ‚Üì
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚úÖ
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Cookie –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º
- –°–µ—Å—Å–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Å–µ–π—á–∞—Å, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –≤–µ–±-–∫–ª–∏–µ–Ω—Ç–∞

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí POST /auth/mobile/login
   ‚Üì
2. –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç:
   - Access Token (JWT, 15 –º–∏–Ω—É—Ç)
   - Refresh Token (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis, 30 –¥–Ω–µ–π)
   ‚Üì
3. –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–∞ —Ç–æ–∫–µ–Ω–∞ –≤ JSON
   ‚Üì
4. –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ Secure Storage
   ‚Üì
5. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Access Token –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ: Authorization: Bearer <token>
   ‚Üì
6. –ï—Å–ª–∏ Access Token –∏—Å—Ç–µ–∫:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Refresh Token –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ Access Token
   ‚Üì
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚úÖ
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Secure Storage –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- Access Token –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π (15 –º–∏–Ω—É—Ç)
- Refresh Token –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π (30 –¥–Ω–µ–π)
- –ú–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å Refresh Token (—É–¥–∞–ª–∏—Ç—å –∏–∑ Redis)

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

#### –î–ª—è –≤–µ–±-—Å–∞–π—Ç–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å):
```
POST /auth/login          - –õ–æ–≥–∏–Ω —Å cookie-—Å–µ—Å—Å–∏–µ–π
POST /auth/logout         - –í—ã—Ö–æ–¥ (—É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏)
POST /auth/register       - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```

#### –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–æ–≤—ã–µ):
```
POST /auth/mobile/login        - –õ–æ–≥–∏–Ω —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏
POST /auth/mobile/refresh      - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Access Token
POST /auth/mobile/logout       - –í—ã—Ö–æ–¥ (—É–¥–∞–ª–µ–Ω–∏–µ Refresh Token)
POST /auth/mobile/register     - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã)
```

**–í–∞–∂–Ω–æ:** –û–±–∞ –Ω–∞–±–æ—Ä–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!

---

### 2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AuthGuard

Guard –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å **–æ–±–∞ –º–µ—Ç–æ–¥–∞** –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```typescript
async canActivate(context: ExecutionContext): Promise<boolean> {
  const request = context.switchToHttp().getRequest();
  
  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º JWT —Ç–æ–∫–µ–Ω (–¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
  const authHeader = request.headers.authorization;
  if (authHeader && authHeader.startsWith('Bearer ')) {
    const token = authHeader.substring(7);
    const user = await this.jwtService.verifyAndGetUser(token);
    if (user) {
      request.user = user;
      return true; // ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ JWT
    }
  }
  
  // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º cookie-—Å–µ—Å—Å–∏—é (–¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞)
  if (request.session?.userId) {
    const user = await this.userService.findById(request.session.userId);
    if (user) {
      request.user = user;
      return true; // ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ —Å–µ—Å—Å–∏—é
    }
  }
  
  // ‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
  throw new UnauthorizedException('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è JWT (–µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization)
2. –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è cookie-—Å–µ—Å—Å–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å session.userId)
3. –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –Ω–µ –ø—Ä–æ—à–µ–ª - –æ—à–∏–±–∫–∞ 401

---

### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤

#### Access Token (JWT)
```json
{
  "userId": "123e4567-e89b-12d3-a456-426614174000",
  "email": "user@example.com",
  "role": "USER",
  "iat": 1234567890,
  "exp": 1234568790  // 15 –º–∏–Ω—É—Ç –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º
- –°–æ–¥–µ—Ä–∂–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- –ö–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π (15 –º–∏–Ω—É—Ç)
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

#### Refresh Token
```json
{
  "token": "550e8400-e29b-41d4-a716-446655440000",  // UUID
  "userId": "123e4567-e89b-12d3-a456-426614174000",
  "expiresAt": "2024-12-14T21:00:00Z",  // 30 –¥–Ω–µ–π
  "deviceId": "mobile-app-123"  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis
- –î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π (30 –¥–Ω–µ–π)
- –ú–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å (—É–¥–∞–ª–∏—Ç—å –∏–∑ Redis)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ Access Token

---

### 4. –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π:

**Refresh Tokens:**
```
refresh_token:<token_uuid> = {
  "userId": "...",
  "expiresAt": "...",
  "deviceId": "..."
}
TTL: 30 –¥–Ω–µ–π
```

**–û—Ç–æ–∑–≤–∞–Ω–Ω—ã–µ Access Tokens (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è blacklist):**
```
blacklist_token:<jwt_id> = "true"
TTL: 15 –º–∏–Ω—É—Ç (–¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞)
```

**Cookie-—Å–µ—Å—Å–∏–∏ (–∫–∞–∫ —Å–µ–π—á–∞—Å):**
```
sess:<session_id> = {
  "userId": "...",
  "currentOrganizationId": "..."
}
TTL: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ SESSION_MAX_AGE
```

---

## üì± –†–∞–±–æ—Ç–∞ —Å –º–æ–±–∏–ª—å–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

### 1. –õ–æ–≥–∏–Ω

**–ó–∞–ø—Ä–æ—Å:**
```http
POST /auth/mobile/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "user": {
    "userId": "123e4567-e89b-12d3-a456-426614174000",
    "email": "user@example.com",
    "firstName": "–ò–≤–∞–Ω",
    "lastName": "–ò–≤–∞–Ω–æ–≤"
  },
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "550e8400-e29b-41d4-a716-446655440000",
  "expiresIn": 900  // 15 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
}
```

**–î–µ–π—Å—Ç–≤–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `accessToken` –∏ `refreshToken` –≤ Secure Storage
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `accessToken` –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

### 2. –ó–∞–ø—Ä–æ—Å—ã –∫ API

**–ó–∞–ø—Ä–æ—Å:**
```http
GET /organizations
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π:**
- –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å JWT
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç `userId` –∏–∑ —Ç–æ–∫–µ–Ω–∞
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

**–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ (401):**
- –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Refresh Token

---

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Access Token

**–ó–∞–ø—Ä–æ—Å:**
```http
POST /auth/mobile/refresh
Content-Type: application/json

{
  "refreshToken": "550e8400-e29b-41d4-a716-446655440000"
}
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 900
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞ - —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π/–∏—Å—Ç–µ–∫):**
```json
{
  "statusCode": 401,
  "message": "Refresh token –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.",
  "error": "Unauthorized"
}
```

**–î–µ–π—Å—Ç–≤–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π `accessToken`
2. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
3. –ï—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞

---

### 4. –í—ã—Ö–æ–¥

**–ó–∞–ø—Ä–æ—Å:**
```http
POST /auth/mobile/logout
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "refreshToken": "550e8400-e29b-41d4-a716-446655440000"
}
```

**–î–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä–≤–µ—Ä–∞:**
1. –£–¥–∞–ª–∏—Ç—å Refresh Token –∏–∑ Redis
2. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–æ–±–∞–≤–∏—Ç—å Access Token –≤ blacklist
3. –í–µ—Ä–Ω—É—Ç—å —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç

**–î–µ–π—Å—Ç–≤–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
1. –£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏–∑ Secure Storage
2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞

---

## üåê –†–∞–±–æ—Ç–∞ —Å –≤–µ–±-—Å–∞–π—Ç–æ–º (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

### –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:

**–õ–æ–≥–∏–Ω:**
```http
POST /auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "user": {
    "userId": "...",
    "email": "..."
  }
}
```

**Cookie —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
```
Set-Cookie: connect.sid=s%3Aabc123...; HttpOnly; Secure; SameSite=Lax
```

**–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:**
- –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie
- –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é –∏–∑ Redis
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Å–µ–π—á–∞—Å ‚úÖ

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### JWT Access Token:
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π (15 –º–∏–Ω—É—Ç) - –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç —Ä–∏—Å–∫ –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏
- ‚úÖ –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º
- ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å blacklist –¥–ª—è –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- ‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å blacklist)

### Refresh Token:
- ‚úÖ –•—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis (–º–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å)
- ‚úÖ –î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π (30 –¥–Ω–µ–π) - —É–¥–æ–±—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (deviceId)
- ‚úÖ –ú–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### Cookie-—Å–µ—Å—Å–∏–∏:
- ‚úÖ HttpOnly - –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ JavaScript
- ‚úÖ Secure - —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTPS
- ‚úÖ SameSite=Lax - –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF
- ‚úÖ –•—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (Redis)

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Cookie-—Å–µ—Å—Å–∏–∏ | JWT + Refresh |
|----------|---------------|---------------|
| **–î–ª—è –≤–µ–±-—Å–∞–π—Ç–∞** | ‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ | ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ |
| **–î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ** | ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | ‚úÖ –í—ã—Å–æ–∫–∞—è | ‚úÖ –í—ã—Å–æ–∫–∞—è |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç Redis | ‚úÖ Stateless (Access Token) |
| **–û—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–æ–≤** | ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ | ‚ö†Ô∏è –¢–æ–ª—å–∫–æ Refresh Token |
| **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** | ‚úÖ –ü—Ä–æ—Å—Ç–æ | ‚ö†Ô∏è –°–ª–æ–∂–Ω–µ–µ |

---

## üõ†Ô∏è –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm install @nestjs/jwt @nestjs/passport passport passport-jwt
npm install -D @types/passport-jwt
```

### –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ JWT —Å–µ—Ä–≤–∏—Å–∞
- `src/auth/jwt/jwt.service.ts` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
- `src/auth/jwt/jwt.module.ts` - –º–æ–¥—É–ª—å JWT

### –≠—Ç–∞–ø 3: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è AuthService
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `mobileLogin()` - –ª–æ–≥–∏–Ω —Å JWT
- `refreshToken()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Access Token
- `mobileLogout()` - –≤—ã—Ö–æ–¥ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º Refresh Token

### –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ AuthGuard
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ cookie-—Å–µ—Å—Å–∏–π
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: JWT ‚Üí Cookie

### –≠—Ç–∞–ø 5: –ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- `POST /auth/mobile/login`
- `POST /auth/mobile/refresh`
- `POST /auth/mobile/logout`
- `POST /auth/mobile/register`

### –≠—Ç–∞–ø 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ OrganizationRoleGuard
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è `organizationId` –∏–∑ JWT payload
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏ –¥–ª—è —Å–µ—Å—Å–∏–π

### –≠—Ç–∞–ø 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –¢–µ—Å—Ç—ã –¥–ª—è –≤–µ–±-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (–¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
- –¢–µ—Å—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- –¢–µ—Å—Ç—ã –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ AuthGuard

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (React Native / Flutter)

**–õ–æ–≥–∏–Ω:**
```typescript
const response = await fetch('https://api.example.com/auth/mobile/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email, password })
});

const { accessToken, refreshToken, user } = await response.json();

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Secure Storage
await SecureStore.setItemAsync('accessToken', accessToken);
await SecureStore.setItemAsync('refreshToken', refreshToken);
```

**–ó–∞–ø—Ä–æ—Å—ã:**
```typescript
const accessToken = await SecureStore.getItemAsync('accessToken');

const response = await fetch('https://api.example.com/organizations', {
  headers: {
    'Authorization': `Bearer ${accessToken}`
  }
});

if (response.status === 401) {
  // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –æ–±–Ω–æ–≤–∏—Ç—å
  await refreshAccessToken();
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:**
```typescript
async function refreshAccessToken() {
  const refreshToken = await SecureStore.getItemAsync('refreshToken');
  
  const response = await fetch('https://api.example.com/auth/mobile/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refreshToken })
  });
  
  if (response.ok) {
    const { accessToken } = await response.json();
    await SecureStore.setItemAsync('accessToken', accessToken);
    return accessToken;
  } else {
    // Refresh token –∏—Å—Ç–µ–∫, –Ω—É–∂–µ–Ω –Ω–æ–≤—ã–π –ª–æ–≥–∏–Ω
    await SecureStore.deleteItemAsync('accessToken');
    await SecureStore.deleteItemAsync('refreshToken');
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞
  }
}
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –≤–µ–±-—Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
2. **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ –º–µ—Ç–æ–¥–∞
3. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - –º–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –∫–∞–∂–¥—ã–π –º–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–º, –≥–¥–µ –æ–Ω –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –æ–±–∞ –º–µ—Ç–æ–¥–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–¢–µ–∫—É—â–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
   - –ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å `currentOrganizationId` –≤ JWT payload
   - –ò–ª–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –Ω–∞ –≤–µ–±-—Å–∞–π—Ç–µ, –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–∑–Ω–∞–µ—Ç –æ–± —ç—Ç–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å WebSocket –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

3. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
   - –ú–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö Refresh Tokens –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ `deviceId`

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–í—Å–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –ü–æ–¥—Ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –º–Ω–æ–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö.

**–í–æ–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º:**
1. –ö–∞–∫–æ–π —Ç–∏–ø –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è? (React Native, Flutter, –Ω–∞—Ç–∏–≤–Ω–æ–µ)
2. –ù—É–∂–Ω–∞ –ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤?
3. –ù—É–∂–Ω–∞ –ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã—Ö–æ–¥–∞ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏?

